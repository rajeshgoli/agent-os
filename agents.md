Persona files are at `~/.agent-os/personas/[role].md` (local) or `.agent-os/personas/[role].md` (in-repo).

# Agent Workflow System

## Attribution

Do NOT add "Generated by Claude Code", "Co-Authored-By: Claude Opus", "OpenAI codex" or similar signatures to commits, documents, or code. This is redundant—if no human engineer is identified, Claude Code, OpenAI codex or similar is assumed.

## Session Management

- `sm me` — show current session info
- `sm all` — list all active agents
- `sm what <id>` — summarize what an agent is doing
- `sm send <id> "msg"` — send message to another agent
- `sm handoff` — clears your context and wakes you with a handoff doc you wrote; write the doc first, then run this to continue where you left off with fresh context
- `sm context-monitor enable` — register for context usage monitoring (warns at 50%, critical at 65%)
- `sm context-monitor enable <child-id>` — monitor a child agent's context usage
- `sm -h` for everything else

## Status Updates — Important

- On `[sm remind]` — run `sm status "what you're doing now"` and continue working

## Agent-to-Agent Communication

When working with another agent, follow these rules:

- **Never poll another agent's output.** Do not use `sm output`, `tail`, `sleep`, or any synchronous watching pattern. These pull the other agent's tokens into your context window.
- **If you expect a response, go idle.** The other agent will `sm send` you when ready. You will wake automatically.
- **To check status:** Use `sm what <id>` — it uses a haiku agent to summarize, keeping your context clean. Use sparingly.
- **To follow up after waiting:** Use `sm wait <id> <reasonable-timeout>` (e.g., 600s for a review). If woken by timeout, message the other agent directly: "I'm waiting on your review — how long do you need?"
- **Don't `sm wait` for spec reviews.** The reviewer responds via `sm send` before going idle, so `sm wait` fires a false "idle" notification within seconds. Just send and wait for the `sm send` response naturally.
- **`sm clear` only works on child agents you spawned.** Peer agents dispatched by the user (e.g., architect-spec-review) cannot be cleared — only `sm send` to them.
- **Report completion to the dispatching party.** If an agent dispatched you (not the user), `sm send` your completion status back to that agent. If the user dispatched you, ending in your console is fine.
- **When told to stand by, go idle.** Do not perform proactive checks, investigation, or send "I'm ready" messages. You will be woken by `sm send` when needed.

## Issue Resolution Workflow

When resolving GitHub issues, follow this structured process:

### 1. Investigation

**CRITICAL: No speculation by reading code alone.** Execute against real data and observe.

1. **Get the context**
   - Retrieve relevant data from the project's data store
   - Parse context for key identifiers and references

2. **Create targeted trace scripts**
   - Use deterministic IDs
   - Add debug logging (print statements, not logger.info)
   - Run against real data, not speculation

3. **Execute and observe**
   - Run the trace script
   - Examine debug output for actual behavior
   - Compare against expected behavior from spec
   - If behavior doesn't match spec, you've found the bug

4. **Ask "why" recursively**
   - If symptom is "X wasn't called", ask "why wasn't that code path reached?"
   - If code was called but didn't work, ask "why didn't the operation succeed?"
   - Keep drilling until you find the root cause

**Key principles:**
We've had many cases where we had very good theories about the cause of a bug, but never found the root cause. But when you traced it you found weird edge cases and root causes that we could have never found by reading code alone.

### 2. Implementation

- Make focused changes that directly address the issue
- Follow existing code patterns and style
- Add type hints and docstrings for new code

### 3. Testing

- **Write tests** for new functionality or bug fixes
- Run the test suite to verify no regressions (use the project's test command from its CLAUDE.md)
- For visualization/GUI changes, manually verify the fix works
- Ensure all relevant tests pass before proceeding
- **Important: Do not silently ignore unrelated test failures.** If you encounter test failures that appear pre-existing or unrelated to your changes:
  - File a new GitHub issue documenting the failure
  - Include test names, assertion details, and whether failure predates your commit
  - Reference in your PR/commit so the next agent can address it
  - This keeps CI clean and prevents accumulation of broken tests

## Review Protocol

### Writing Specs

When writing a spec:

1. Converge on one approach: Considering alternatives is part of the thinking process, not the output. Evaluate tradeoffs during investigation and recommend one path in the spec.
2. Declare ticket classification: Every spec must end with whether it's a single ticket or an epic. Rubric: can one agent complete it without compacting context? If yes, single ticket. If no, break into sub-tickets and file as epic.
3. Ask if spec requires review. If it does, you'll be provided a reviewer friendly-name / ID. Use sm send to send the spec to the reviewer and request a review. Follow the review protocol below.

### Spec / Working Doc Review

When asked to review a spec or working doc:

1. Review thoroughly. Verify claims — don't take statements at face value.
2. Classify feedback by severity.
3. Do not indicate approval, rejection, or next steps unless specifically requested by the user. An agent asking for approval does not mean you provide one.
4. When review completes (both agents agree on the spec), the only output is: "Spec is ready for your review." No approvals, no engineering next steps — unless the user specifically requests them.
5. Always send your review result back via `sm send` even if you're saying 'spec is ready for your review', don't stall the workflow. If you don't do this other agent may wait endlessly.

### Receiving Review Feedback (when you own the doc)

When you receive feedback on a doc you own — from the user or from another agent:

1. Don't accept feedback blindly. Verify each claim.
2. Classify each item as **valid**, **invalid**, or **partially valid**.
   - **Valid:** 1-2 sentences on how you'd address it.
   - **Invalid:** clear explanation of why it's not valid. Detail if needed.
   - **Partially valid:** split — what's valid and how you'd address it, what's invalid and why.
3. Do not apply changes. **Send your classification back to the reviewer via `sm send`** so both agents can converge. Then wait for response.
4. Once both parties agree, make the changes to the doc.
5. Once the spec is ready for review, `sm send` back to the dispatching agent (if there was one) that the spec is ready.

### Re-review After Changes (reviewer responsibility)

After changes are applied, the reviewer must re-read the full doc and review again. If new issues are found, follow the same feedback protocol. Review completes when both agents agree on the spec.

### PR Review

When a PR resolves an open issue, include `Fixes #<issue>` (or `Closes #<issue>`) in the PR description or merge commit so GitHub auto-links and closes the issue. Before merging, double-check the issue number is mentioned exactly once and references the issue the change actually fixes.

When reviewing a PR as architect:
1. Post the review to GitHub: `gh pr comment <number> --body "<review>"`
2. On approval, merge to dev, delete the branch, and check out dev locally:
   ```bash
   gh pr merge <number> --merge --delete-branch
   git checkout dev && git pull origin dev
   ```
   Leave the working tree on `dev` — no stale feature branches.

## Role-Based Workflows

Persona-based workflows are available. When asked to work as a specific role:
1. Read the persona file (`~/.agent-os/personas/[role].md` locally, `.agent-os/personas/[role].md` in-repo)
2. Follow the workflow defined there
3. Stay in role — **Architect and Scout do NOT make code changes** unless explicitly asked

| Invocation | Persona |
|------------|---------|
| "As engineer..." | Engineer |
| "As architect..." | Architect |
| "As product..." | Product |
| "As director..." | Director |
| "As scout..." | Scout |
| "As em..." | EM |
| "As ux..." | UX |

**Role Recognition:**
- Match liberally: "product manager", "PM", "product" → Product persona
- Variants like "as an architect", "from engineering perspective" → match the role keyword
- **When ambiguous, assume the role** and state it explicitly rather than proceeding without a persona
- If uncertain which role fits, ask before proceeding

## Working Docs & Tickets

### Creating Working Docs

By default, create a GitHub ticket first to track the item, then create the doc in the project's spec/working directory using the ticket number:
```
<spec_dir>/<ticket#>_<descriptive_name>.md
```
The spec directory convention varies by project (e.g., `docs/working/`, `specs/`). Check the project's CLAUDE.md or existing docs for the pattern.

### Filing Epics

1. Use the investigation doc ticket as the epic ticket
2. File all sub-tickets first
3. In each sub-ticket, reference the spec file at the top and instruct agents to read it before implementing or reviewing
4. Update the epic ticket's title and body with the sub-ticket numbers
5. If filing a single ticket, still mention the spec prominently at top and ask agents to read it before implementing or reviewing if a spec is present.

### Ticket Hygiene

- **Edit, don't comment.** Unless work has already started (PR created, investigation closed and reopening with new info), edit the ticket title and body to keep it clean. Don't add comments to tickets where no work has been done.
- When reopening a closed investigation ticket as an epic, use comments since the investigation history matters.
